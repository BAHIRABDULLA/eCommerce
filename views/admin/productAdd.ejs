<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Regal Admin</title>
  <!-- base:css -->
  <link rel="stylesheet" href="vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="vendors/feather/feather.css">
  <link rel="stylesheet" href="vendors/base/vendor.bundle.base.css">
  <!-- endinject -->
  <!-- plugin css for this page -->
  <link rel="stylesheet" href="vendors/select2/select2.min.css">
  <link rel="stylesheet" href="vendors/select2-bootstrap-theme/select2-bootstrap.min.css">
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <link rel="stylesheet" href="css/style.css">

  <!-- start cropper js -->
  <!-- <link rel="stylesheet" href="cropperJs/cropper.css">-->
  <!-- <script src="cropperJs/cropper.js"></script>  -->


 

  <!-- endinject -->
  <link rel="shortcut icon" href="images/favicon.png" />

  <!-- starting cropper js -->

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">



  <!-- ending cropper js -->
</head>

<body>
  <div class="container-scroller">
    <!-- partial:partials/_navbar.html -->
    <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
      <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
        <a class="navbar-brand brand-logo" href="index.html"><img src="images/logo.svg" alt="logo" /></a>
        <a class="navbar-brand brand-logo-mini" href="index.html"><img src="images/logo-mini.svg" alt="logo" /></a>
      </div>
      <div class="navbar-menu-wrapper d-flex align-items-center justify-content-end">
        <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
          <span class="icon-menu"></span>
        </button>
        <ul class="navbar-nav mr-lg-2">
          <!-- <li class="nav-item nav-search d-none d-lg-block">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text" id="search">
                  <i class="icon-search"></i>
                </span>
              </div>
              <input type="text" class="form-control" placeholder="Search Projects.." aria-label="search"
                aria-describedby="search">
            </div>
          </li> -->
        </ul>
        <ul class="navbar-nav navbar-nav-right">


          <li class="nav-item dropdown d-flex mr-4 ">
            <a class="nav-link count-indicator dropdown-toggle d-flex align-items-center justify-content-center"
              id="notificationDropdown" href="#" data-toggle="dropdown">
              <i class="icon-cog"></i>
            </a>
            <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list"
              aria-labelledby="notificationDropdown">
              <p class="mb-0 font-weight-normal float-left dropdown-header">Settings</p>
              <a class="dropdown-item preview-item">
                <i class="icon-head"></i> Profile
              </a>
              <a class="dropdown-item preview-item">
                <i class="icon-inbox"></i> Logout
              </a>
            </div>
          </li>
          <li class="nav-item dropdown mr-4 d-lg-flex d-none">
            <a class="nav-link count-indicatord-flex align-item s-center justify-content-center" href="#">
              <i class="icon-grid"></i>
            </a>
          </li>
        </ul>
        <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button"
          data-toggle="offcanvas">
          <span class="icon-menu"></span>
        </button>
      </div>
    </nav>
  </div>
  <!-- partial -->
  <div class="container-fluid page-body-wrapper">
    <!-- partial:partials/_sidebar.html -->
    <nav class="sidebar sidebar-offcanvas" id="sidebar">
      <div class="user-profile">
        <div class="user-image">
          <img src="images/faces/admin.webp">
        </div>
        <div class="user-name">
          Bahir Abdulla
        </div>
        <div class="user-designation">
          Manager
        </div>
      </div>
      <ul class="nav">
        <li class="nav-item">
          <a class="nav-link" href="/admin/dashboard">
            <i class="icon-box menu-icon"></i>
            <span class="menu-title">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/customer">
            <i class="icon-command menu-icon"></i>
            <span class="menu-title">Customers</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/category">
            <i class="icon-disc menu-icon"></i>
            <span class="menu-title">Category</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/products">
            <i class="icon-file menu-icon"></i>
            <span class="menu-title">Products</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/orders">
            <i class="icon-pie-graph menu-icon"></i>
            <span class="menu-title">Orders</span>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="/admin/offer">
            <i class="icon-help menu-icon"></i>
            <span class="menu-title">Offer</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/coupon">
            <i class="icon-help menu-icon"></i>
            <span class="menu-title">Coupons</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="pages/icons/feather-icons.html">
            <i class="icon-help menu-icon"></i>
            <span class="menu-title">Banner</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/logout">
            <i class="icon-head menu-icon"></i>
            <span class="menu-title">Logout</span>
            <!-- <i class="menu-arrow"></i> -->
          </a>
          <!-- <div class="collapse" id="auth">
                <ul class="nav flex-column sub-menu">
                  <li class="nav-item"> <a class="nav-link" href="pages/samples/login.html"> Login </a></li>
              
                </ul>
            </div> -->
        </li>

      </ul>
    </nav>
    <!-- partial -->
    <div class="main-panel">
      <a href="/admin/products" class="btn btn-info   ">Back</a>
      <div class="content-wrapper">
        <!-- /////////////////////////////////////////////////// -->
        <div class="modal" id="cropModal1" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Crop Image</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <img id="croppedImage1" src="" alt="Cropped Image">
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveCroppedImage">Save</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal" id="cropModal2" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Crop Image</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <img id="croppedImage2" src="" alt="Cropped Image">
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveCroppedImage">Save</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div><div class="modal" id="cropModal3" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Crop Image</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <img id="croppedImage3" src="" alt="Cropped Image">
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveCroppedImage">Save</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div><div class="modal" id="cropModal4" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Crop Image</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <img id="croppedImage4" src="" alt="Cropped Image">
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveCroppedImage">Save</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ///////////////////////////////////// -->

        <div class="col-12 grid-margin">
          <div class="card">
            <div class="card-body">
              <form id="productForm" action="/admin/productAdd" method="post" enctype="multipart/form-data">

                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="exampleInputName1">Product Name</label>
                      <input type="text" class="form-control" id="exampleInputName1Name1" name="name" placeholder="Name">
                      <small class="text-danger" id="productNameError"></small>
                    </div>

                  </div>

                </div>
                <div class="row">
                  <div class="col-md-12">

                    <div class="form-group row">
                      <label class="col-sm-3 col-form-label">Category</label>
                      <div class="col-sm-12">
                        <select class="form-control" id="category-select">
                          <option value="" disabled selected>Select a category</option>
                          <% categories.forEach(category=>{ %>
                            <option value="<%= category._id %>">
                              <%= category.name %>
                            </option>
                            <% }) %>
                        </select>
                      </div>
                      <small class="text-danger" id="categoryError"></small>

                    </div>
                  </div>
                </div>

                <input type="hidden" id="selected-category" name="category">

                <div class="row ">
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-3  col-form-label">Price</label>
                      <div class="col-sm-4  col-lg-4">
                        <input type="text" name="price" class="form-control" />
                      </div>
                      <small class="text-danger" id="priceError"></small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-3 col-form-label">Quantity</label>
                      <div class="col-sm-4  col-lg-4">
                        <input type="text" name="quantity" class="form-control" />
                      </div>
                      <small class="text-danger" id="quantityError"></small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-3 col-form-label">Size</label>
                      <div class="col-sm-4  col-lg-4 ">
                        <input type="text" name="size" class="form-control" />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="exampleTextarea1">Description</label>
                      <textarea class="form-control" id="exampleTextarea1" name="description" rows="4"></textarea>
                    </div>
                    <small class="text-danger" id="descriptionError"></small>
                  </div>

                  <div class="row">
                    <div class="col-lg-3 ">
                      <div class="form-group">
                        <label>File upload</label>

                        <input type="file" name="image1" class="file-upload-default image-input" id="imageInput1" data-target="#cropModal1">
                        <div class="input-group col-xs-12">
                          <input type="text" class="form-control file-upload-info" disabled placeholder="Upload Image">
                          <span class="input-group-append">
                            <button class="file-upload-browse btn btn-primary" type="button">Upload</button>
                          </span>
                        </div>
                        <small class="text-danger" id="imageError"></small>
                      </div>
                    </div>
                    <div class="col-lg-3 ">
                      <div class="form-group">
                        <label>File upload</label>
                        <input type="file" name="image2" class="file-upload-default image-input" id="imageInput2" data-target="#cropModal2">

                        <div class="input-group col-xs-12">
                          <input type="text" class="form-control file-upload-info" disabled placeholder="Upload Image">
                          <span class="input-group-append">
                            <button class="file-upload-browse btn btn-primary" type="button">Upload</button>
                          </span>
                        </div>
                        <small class="text-danger" id="imageError"></small>
                      </div>
                    </div>
                    <div class="col-lg-3 ">
                      <div class="form-group">
                        <label>File upload</label>
                        <input type="file" name="image3" class="file-upload-default image-input" id="imageInput3" data-target="#cropModal3">

                        <div class="input-group col-xs-12">
                          <input type="text" class="form-control file-upload-info" disabled placeholder="Upload Image">
                          <span class="input-group-append">
                            <button class="file-upload-browse btn btn-primary" type="button">Upload</button>
                          </span>
                        </div>
                        <small class="text-danger" id="imageError"></small>
                      </div>
                    </div>
                    <div class="col-lg-3 ">
                      <div class="form-group">
                        <label>File upload</label>

                        <input type="file" name="image4" class="file-upload-default image-input" id="imageInput4" data-target="#cropModal4">

                        <div class="input-group col-xs-12">
                          <input type="text" class="form-control file-upload-info" disabled placeholder="Upload Image">
                          <span class="input-group-append">
                            <button class="file-upload-browse btn btn-primary" type="button">Upload</button>
                          </span>
                        </div>
                        <small class="text-danger" id="imageError"></small>
                      </div>
                    </div>

                  </div>
                  <div class="row col-12">
                    <button type="button" onclick="saveForm()" class="btn btn-primary mr-2">Save</button>
                    <!-- <a href="/admin/products"><button class="btn btn-light">Back</button></a> -->
                  </div>
                </div>
              </form>
            </div>
          </div>


        </div>
        <!-- content-wrapper ends -->
        <!-- partial:partials/_footer.html -->

        <!-- partial -->
      </div>
      <!-- main-panel ends -->
    </div>
    <!-- page-body-wrapper ends -->
  </div>
  <script>


    const categorySelect = document.getElementById('category-select')
    const selectedCategoryInput = document.getElementById('selected-category')
    categorySelect.addEventListener('change', function () {
      const selectedCategory = categorySelect.value
      selectedCategoryInput.value = selectedCategory
      console.log('selected category ', selectedCategory)
    })


    // validation starts here
    document.getElementById('productForm').addEventListener('submit', (event) => {
      event.preventDefault()
      const productName = document.getElementById('exampleInputName1Name1').value.trim()
      const price = document.querySelector('input[name="price"]').value.trim()
      const quantity = document.querySelector('input[name="quantity"]').value.trim();
      const description = document.getElementById('exampleTextarea1').value.trim();
      const categorySelect = document.getElementById('category-select')
      const images = document.querySelectorAll('input[name="image"]')

      const productNameError = document.getElementById('productNameError')
      const priceError = document.getElementById('priceError')
      const quantityError = document.getElementById('quantityError')
      const descriptionError = document.getElementById('descriptionError');
      const categoryError = document.getElementById('categoryError')
      const imageError = document.getElementById('imageError')

      let isValid = true
      if (!productName) {
        productNameError.innerText = 'Product name cannot be empty'
        isValid = false
      } else {
        productNameError.innerText = ''
      }

      if (!/^\d+(\.\d{1,2})?$/.test(price)) {
        priceError.innerText = 'Price must be a positive integer ';
        isValid = false;
      } else {
        priceError.innerText = '';
      }

      if (!/^\d+$/.test(quantity)) {
        quantityError.innerText = 'Quantity must be a positive integer';
        isValid = false;
      } else {
        quantityError.innerText = '';
      }

      if (!description) {
        descriptionError.innerText = 'Description cannot be empty';
        isValid = false;
      } else {
        descriptionError.innerText = '';
      }
      if (categorySelect.value === '') {
        categoryError.innerText = 'Please choose a category'
        isValid = false;
      } else {
        categoryError.innerText = ''
      }
      let hasImage = false
      images.forEach((image) => {
        if (image.files.length > 0) {
          hasImage = true
        }
      })
      if (!hasImage) {
        imageError.innerText = 'Please upload at least one image'
        isValid = false
      } else {
        imageError.innerText = ''
      }
      if (isValid) {
        document.getElementById('productForm').submit();
      }

    })



    // this is for image cropping 

    document.addEventListener('DOMContentLoaded', function () {
      const imageInputs = document.querySelectorAll('.image-input');

      imageInputs.forEach(function (imageInput) {
        imageInput.addEventListener('change', function () {
          const files = this.files;
          const file = files[0];

          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              const img = new Image()
              img.src = event.target.result
              img.onload = function () {
                const cropperModalId = imageInput.dataset.target
                const cropperModal = document.querySelector(cropperModalId)
                const modalBody = cropperModal.querySelector('.modal-body')
                const croppedImageId=cropperModalId.replace('Modal','Image')
                const croppedImage = document.querySelector('#'+croppedImageId)

                modalBody.innerHTML = ''
                modalBody.appendChild(img)
                const cropper = new Cropper(img, {
                  aspectRatio: 1,
                  viewMode: 1,
                  dragMode: "move",
                  minContainerWidth: 450,
                  minContainerHeight: 500,
                  minCropBoxWidth: 400,
                  minCropBoxHeight: 400,
                  minCanvasHeight: 500,
                  minCanvasWidth: 500,
                  // viewport: {
                  // width: 200, 
                  // height: 200
                  // }
                  crop: (event => {
                    croppedImage.src = cropper.getCroppedCanvas().toDataURL()
                  })
                })
                $(cropperModal).modal('show')
                const saveButton=cropperModal.querySelector('#saveCroppedImage')
                saveButton.addEventListener('click',()=>{
                  const canvas=cropper.getCroppedCanvas()
                  canvas.toBlob(function(blob){
                    const formData=new FormData()
                    formData.append('croppedImage',blob,'croppedImage.png')
                  })
                  $(cropperModal).modal('hide')
                })
              }
            }
            reader.readAsDataURL(file)
          }
        })
      })
    })  
    function saveForm(){
      let formData=new FormData(document.getElementById('productForm'))
    
      fetch('/admin/productAdd',{
        method:'POST',
        body:formData
      })
      .then(response=>response.json())
      .then(data=>{
        console.log(data);
      })
      .catch(error=>{
        console.error('Error',error);
      })
    }


  </script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <!-- container-scroller -->
  <!-- base:js -->
  <script src="vendors/base/vendor.bundle.base.js"></script>
  <!-- endinject -->
  <!-- inject:js -->
  <script src="js/off-canvas.js"></script>
  <script src="js/hoverable-collapse.js"></script>
  <script src="js/template.js"></script>
  <!-- endinject -->
  <!-- plugin js for this page -->
  <script src="vendors/typeahead.js/typeahead.bundle.min.js"></script>
  <script src="vendors/select2/select2.min.js"></script>
  <!-- End plugin js for this page -->
  <!-- Custom js for this page-->
  <script src="js/file-upload.js"></script>
  <script src="js/typeahead.js"></script>
  <script src="js/select2.js"></script>
  <!-- End custom js for this page-->
</body>

</html>